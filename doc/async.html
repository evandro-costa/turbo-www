

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>turbo.async – Asynchronous clients &mdash; Turbo.lua 1.0.0 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Turbo.lua 1.0.0 documentation" href="index.html" />
    <link rel="next" title="turbo.ioloop – Main I/O Loop" href="ioloop.html" />
    <link rel="prev" title="turbo.web – Core web framework" href="web.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="ioloop.html" title="turbo.ioloop – Main I/O Loop"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="web.html" title="turbo.web – Core web framework"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Turbo.lua 1.0.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="turbo-async-asynchronous-clients">
<span id="async"></span><h1>turbo.async &#8211; Asynchronous clients<a class="headerlink" href="#turbo-async-asynchronous-clients" title="Permalink to this headline">¶</a></h1>
<div class="section" id="httpclient-class">
<h2>HTTPClient class<a class="headerlink" href="#httpclient-class" title="Permalink to this headline">¶</a></h2>
<p>Based on the IOStream/SSLIOStream and IOLoop classes.
Designed to asynchronously communicate with a HTTP server via the Turbo I/O
Loop. The user MUST use Lua&#8217;s builtin coroutines to manage yielding, after
doing a request. The aim for the client is to support as many standards of
HTTP as possible. However there may be some artifacts as there usually are
many compability fixes in equivalent software such as curl.
Websockets are not handled by this class. It is the users responsibility to
check the returned values for errors before usage.</p>
<p>When using this class, keep in mind that it is not supported to launch
muliple :fetch()&#8217;s with the same class instance. If the instance is already
in use then it will return a error.</p>
<p>Usage inside a <tt class="docutils literal"><span class="pre">turbo.web.RequestHandler</span></tt> method:</p>
<div class="highlight-lua"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre>     <span class="kd">local</span> <span class="n">res</span> <span class="o">=</span> <span class="nb">coroutine.yield</span><span class="p">(</span>
             <span class="n">turbo</span><span class="p">.</span><span class="n">async</span><span class="p">.</span><span class="n">HTTPClient</span><span class="p">():</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">http://domain.com/latest&quot;</span><span class="p">))</span>
     <span class="k">if</span> <span class="n">res</span><span class="p">.</span><span class="n">error</span> <span class="k">then</span>
             <span class="n">self</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Could not get latest from domain.come&quot;</span><span class="p">)</span>
     <span class="k">else</span>
             <span class="n">self</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">body</span><span class="p">)</span>
     <span class="k">end</span>
</pre></div>
</td></tr></table></div>
<dl class="function">
<dt id="HTTPClient">
<tt class="descname">HTTPClient</tt><big>(</big><em>ssl_options</em>, <em>io_loop</em>, <em>max_buffer_size</em><big>)</big><a class="headerlink" href="#HTTPClient" title="Permalink to this definition">¶</a></dt>
<dd><p>Create a new HTTPClient class instance. One instance can serve 1 request
at a time. If multiple request should be sent then create multiple instances.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>ssl_options</strong> (<em>Table</em>) &#8211; SSL keys, verify certificate, CA path etc.</li>
<li><strong>io_loop</strong> (<em>IOLoop class instance.</em>) &#8211; Provide a IOLoop instance or global instance is used.</li>
<li><strong>max_buffer_size</strong> (<em>Number</em>) &#8211; Maximum response buffer size in bytes.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>Available SSL options:</p>
<ul class="simple">
<li>&#8220;priv_file&#8221; (String) - Path to SSL / HTTPS private key file.</li>
<li>&#8220;cert_file&#8221; (String) - Path to SSL / HTTPS certificate key file.</li>
<li>&#8220;ca_path&#8221; (String) - Path to SSL / HTTPS CA certificate verify location, if not given builtin is used, which is copied from Ubuntu 12.10.</li>
<li>&#8220;verify_ca&#8221; (Boolean) SSL / HTTPS verify servers certificate. Default is true.</li>
</ul>
</dd></dl>

<dl class="attribute">
<dt id="errors">
<tt class="descname">errors</tt><a class="headerlink" href="#errors" title="Permalink to this definition">¶</a></dt>
<dd><p>Numeric error codes set in the HTTPResponse returned by <tt class="docutils literal"><span class="pre">HTTPClient:fetch</span></tt>:</p>
<blockquote>
<div><p>INVALID_URL            - URL could not be parsed.</p>
<p>INVALID_SCHEMA         - Invalid URL schema</p>
<p>COULD_NOT_CONNECT      - Could not connect, check message.</p>
<p>PARSE_ERROR_HEADERS    - Could not parse response headers.</p>
<p>CONNECT_TIMEOUT        - Connect timed out.</p>
<p>REQUEST_TIMEOUT        - Request timed out.</p>
<p>NO_HEADERS             - Shouldn&#8217;t happen.</p>
<p>REQUIRES_BODY          - Expected a HTTP body, but none set.</p>
<p>INVALID_BODY           - Request body is not a string.</p>
<p>SOCKET_ERROR           - Socket error, check message.</p>
<p>SSL_ERROR              - SSL error, check message.</p>
</div></blockquote>
</dd></dl>

<dl class="function">
<dt>
<tt class="descname">HTTPClient:fetch(url, kwargs)</tt></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>url</strong> (<em>String</em>) &#8211; URL to fetch.</li>
<li><strong>kwargs</strong> (<em>Table</em>) &#8211; Keyword arguments</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return type:</th><td class="field-body"><p class="first last"><tt class="docutils literal"><span class="pre">turbo.coctx.CoroutineContext</span></tt> class instance. Resumes coroutine with <tt class="docutils literal"><span class="pre">turbo.async.HTTPResponse</span></tt>.</p>
</td>
</tr>
</tbody>
</table>
<p>Available keyword arguments:</p>
<ul class="simple">
<li>&#8220;method&#8221; - The HTTP method to use. Default is &#8220;GET&#8221;</li>
<li>&#8220;params&#8221; - Provide parameters as table.</li>
<li>&#8220;cookie&#8221; - The cookie to use.</li>
<li>&#8220;http_version&#8221; - Set HTTP version. Default is HTTP1.1</li>
<li>&#8220;use_gzip&#8221; - Use gzip compression. Default is true.</li>
<li>&#8220;allow_redirects&#8221; - Allow or disallow redirects. Default is true.</li>
<li>&#8220;max_redirects&#8221; - Maximum redirections allowed. Default is 4.</li>
<li>&#8220;on_headers&#8221; - Callback to be called when assembling request HTTPHeaders instance. Called with <tt class="docutils literal"><span class="pre">turbo.httputil.HTTPHeaders</span></tt> as argument.</li>
<li>&#8220;body&#8221; - Request HTTP body in plain form.</li>
<li>&#8220;request_timeout&#8221; - Total timeout in seconds (including connect) for request. Default is 60 seconds.</li>
<li>&#8220;connect_timeout&#8221; - Timeout in seconds for connect. Default is 20 secs.</li>
<li>&#8220;auth_username&#8221; - Basic Auth user name.</li>
<li>&#8220;auth_password&#8221; - Basic Auth password.</li>
<li>&#8220;user_agent&#8221; - User Agent string used in request headers. Default is &#8220;Turbo Client vx.x.x&#8221;.</li>
</ul>
</dd></dl>

</div>
<div class="section" id="httpresponse-class">
<h2>HTTPResponse class<a class="headerlink" href="#httpresponse-class" title="Permalink to this headline">¶</a></h2>
<p>Represents a HTTP response by a few attributes. Returned by <tt class="docutils literal"><span class="pre">turbo.async.HTTPClient:fetch</span></tt>.</p>
<blockquote>
<div><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">error:</th><td class="field-body">(Table) Table with code and message members. Possible codes is defined in <tt class="docutils literal"><span class="pre">async.errors</span></tt>. Always check if the error attribute is set, before trying to access others. If error is set, then all of the other attributes, except request_time is nil.</td>
</tr>
<tr class="field-even field"><th class="field-name">request:</th><td class="field-body">(HTTPHeaders class instance) The request header sent to the server.</td>
</tr>
<tr class="field-odd field"><th class="field-name">code:</th><td class="field-body">(Number) The HTTP response code</td>
</tr>
<tr class="field-even field"><th class="field-name">headers:</th><td class="field-body">(HTTPHeader class instance) Response headers recieved from the server.</td>
</tr>
<tr class="field-odd field"><th class="field-name">body:</th><td class="field-body">(String) Body of response</td>
</tr>
<tr class="field-even field"><th class="field-name">request_time:</th><td class="field-body">(Number) msec used to process request.</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">turbo.async &#8211; Asynchronous clients</a><ul>
<li><a class="reference internal" href="#httpclient-class">HTTPClient class</a></li>
<li><a class="reference internal" href="#httpresponse-class">HTTPResponse class</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="web.html"
                        title="previous chapter">turbo.web &#8211; Core web framework</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="ioloop.html"
                        title="next chapter">turbo.ioloop &#8211; Main I/O Loop</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/async.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="ioloop.html" title="turbo.ioloop – Main I/O Loop"
             >next</a> |</li>
        <li class="right" >
          <a href="web.html" title="turbo.web – Core web framework"
             >previous</a> |</li>
        <li><a href="index.html">Turbo.lua 1.0.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, John Abrahamsen.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>